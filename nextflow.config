/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    WrightonLabCSU/dram Nextflow config file
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Default config options for all compute environments
    See --help for usage
----------------------------------------------------------------------------------------
*/

// Include constants

includeConfig 'conf/constants.config'

// Global default params, used in configs
params {

    //

    /* Pipeline Steps */
    rename                     = false
    call                       = false
    annotate                   = false
    merge_annotations          = null  // Directory containing .tsv files to merge_annotations
    distill_topic              = ""
    distill_ecosystem          = ""
    distill_custom             = ""
    product                    = false
    adjectives                 = false
    format_kegg                = false

    /* Genome options */
    input_fasta                = null
    fasta_fmt                  = '*.f*'
    input_genes                = null
    genes_fmt                  = '*.faa'
    genes_fna_fmt              = '*.fna'

    /* Call Prodigal Options */
    prodigal_mode = 'meta'
    prodigal_trans_table = 11
    min_contig_len = 2500

    /* Annotate Options */
    // Annotation Database Flags
    use_kegg = false
    use_kofam = false
    use_dbcan = false
    use_camper = false
    use_fegenie = false
    use_methyl = false
    use_canthyd = false
    // use_heme = false
    use_sulfur = false
    use_pfam = false
    use_merops = false
    use_uniref = false
    use_vog = false  // TODO: Add vog annotation
    // use_viral = false  // TODO: Add viral annotation

    add_annotations = null
    bit_score_threshold =  60 // MMseqs threshold search to retain hits.
    rbh_bit_score_threshold =  350

    /* Taxonomy and Bin Quality ingest */
    taxa = null
    bin_quality = null

    /* Database list for generating GFF and GBK */
    database_list = "empty"
    generate_gff = false
    generate_gbk = false

    // Distill options
    annotations = null
    // RNA Sheets
    rrnas = null
    trnas = null

    /* E-value cutoffs for each database */
    kegg_e_value = "1e-5"
    kofam_e_value = "1e-5"
    dbcan_e_value = "1e-15"
    merops_e_value = "1e-1"
    vog_e_value = "1e-5"
    camper_e_value = "1e-5"
    uniref_e_value = "1e-5"
    canthyd_e_value = "1e-5"
    sulfur_e_value = "1e-5"
    fegenie_e_value = "1e-5"

    // Database locations
    // KEGG
    kegg_db = "${launchDir}/databases/kegg/"
    // Uniref
    uniref_db = "${launchDir}/databases/uniref/"
    // Pfam
    pfam_mmseq_db = "${launchDir}/databases/pfam/mmseqs/"
    // merops
    merops_db = "${launchDir}/databases/merops/"
    // viral
    viral_db = "${launchDir}/databases/viral/"
    // kofam
    kofam_db = "${launchDir}/databases/kofam/"
    kofam_list = "${launchDir}/databases/kofam/kofam_ko_list.tsv"
    // dbcan
    dbcan_db = "${launchDir}/databases/dbcan/"
    dbcan_fam_activities = "${launchDir}/databases/dbcan/dbcan.fam-activities.tsv"
    dbcan_subfam_activities = "${launchDir}/databases/dbcan/dbcan.fam-activities.tsv"
    // vogdb
    vog_db = "${launchDir}/databases/vogdb/"
    vog_list = "${launchDir}/databases/vogdb/vog_annotations_latest.tsv.gz"
    // CAMPER
    camper_hmm_db = "${launchDir}/databases/camper/hmm/"
    camper_hmm_list = "${launchDir}/databases/camper/hmm/camper_hmm_scores.tsv"
    camper_mmseqs_db = "${launchDir}/databases/camper/mmseqs/"
    camper_mmseqs_list = "${launchDir}/databases/camper/mmseqs/camper_scores.tsv"
    // cant hyd
    canthyd_hmm_db = "${launchDir}/databases/canthyd/hmm/"
    cant_hyd_hmm_list = "${launchDir}/databases/canthyd/hmm/cant_hyd_HMM_scores.tsv"
    canthyd_mmseqs_db = "${launchDir}/databases/canthyd/mmseqs/"
    canthyd_mmseqs_list = "${launchDir}/databases/canthyd/mmseqs/cant_hyd_BLAST_scores.tsv"
    // fegenie
    fegenie_db = "${launchDir}/databases/fegenie/"
    fegenie_list = "${launchDir}/databases/fegenie/fegenie_iron_cut_offs.txt"
    // Sulfur
    sulfur_db = "${launchDir}/databases/sulfur/"
    // Methyl
    methyl_db = "${launchDir}/databases/methyl/"
    // SQL annotation descriptions database
    sql_descriptions_db = "${launchDir}/databases/db_descriptions/description_db.sqlite"

    /* Product options */
    groupby_column = params.CONSTANTS.FASTA_COLUMN

    /* Adjectives Options */
    adjectives_list = ""

    /* Format KEGG options */
    kegg_pep_root_dir = null
    kegg_pep_loc = null
    gene_ko_link_loc = null
    kegg_download_date = null
    skip_gene_ko_link = false

    /* SLURM options */
    slurm = false
    partition = null
    slurm_node = null
    queue_size = 10


    /* MultiQC options */
    multiqc_config             = null
    multiqc_title              = null
    multiqc_logo               = null
    max_multiqc_email_size     = '25.MB'
    multiqc_methods_description = null

    /* Boilerplate options */
    outdir                       = null
    threads                      = 10
    // Distill sheets
    // Dummy sheet
    distill_dummy_sheet          = "${projectDir}/assets/forms/distill_sheets/dummy.tsv"
    // Topic
    distill_carbon_sheet         = "${projectDir}/assets/forms/distill_sheets/distill_carbon.tsv"
    distill_energy_sheet         = "${projectDir}/assets/forms/distill_sheets/distill_energy.tsv"
    distill_misc_sheet           = "${projectDir}/assets/forms/distill_sheets/distill_misc.tsv"
    distill_nitrogen_sheet       = "${projectDir}/assets/forms/distill_sheets/distill_nitrogen.tsv"
    distill_transport_sheet      = "${projectDir}/assets/forms/distill_sheets/distill_transport.tsv"
    distill_camper_sheet         = "${projectDir}/assets/forms/distill_sheets/distill_camper.tsv"
    // Ecosystem
    distill_eng_sys_sheet        = "${projectDir}/assets/forms/distill_sheets/distill_eng_sys.tsv"
    distill_ag_sheet             = "${projectDir}/assets/forms/distill_sheets/distill_ag.tsv"

    publish_dir_mode             = 'copy'
    email                        = null
    email_on_fail                = null
    plaintext_email              = false
    monochrome_logs              = false
    hook_url                     = null
    help                         = false
    // help_full                    = false
    // show_hidden                  = false
    version                      = false
    pipelines_testdata_base_path = 'https://raw.githubusercontent.com/nf-core/test-datasets/'
    trace_report_suffix          = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')// Config options
    config_profile_name        = null
    config_profile_description = null

    custom_config_version      = 'master'
    custom_config_base         = "https://raw.githubusercontent.com/nf-core/configs/${params.custom_config_version}"
    config_profile_contact     = null
    config_profile_url         = null

    // Schema validation default options
    validate_params            = true
}

// Load base.config by default for all pipelines
includeConfig 'conf/base.config'

profiles {
    debug {
        dumpHashes              = true
        process.beforeScript    = 'echo $HOSTNAME'
        cleanup                 = false
        nextflow.enable.configProcessNamesValidation = true
    }
    conda {
        conda.enabled           = true
        docker.enabled          = false
        singularity.enabled     = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
        conda.channels          = ['conda-forge', 'bioconda']
        apptainer.enabled       = false
    }
    mamba {
        conda.enabled           = true
        conda.useMamba          = true
        docker.enabled          = false
        singularity.enabled     = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
        apptainer.enabled       = false
    }
    docker {
        docker.enabled          = true
        conda.enabled           = false
        singularity.enabled     = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
        apptainer.enabled       = false
        docker.runOptions       = '-u $(id -u):$(id -g)'
    }
    arm {
        docker.runOptions       = '-u $(id -u):$(id -g) --platform=linux/amd64'
    }
    singularity {
        singularity.enabled     = true
        singularity.autoMounts  = true
        conda.enabled           = false
        docker.enabled          = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
        apptainer.enabled       = false
    }
    podman {
        podman.enabled          = true
        conda.enabled           = false
        docker.enabled          = false
        singularity.enabled     = false
        shifter.enabled         = false
        charliecloud.enabled    = false
        apptainer.enabled       = false
    }
    shifter {
        shifter.enabled         = true
        conda.enabled           = false
        docker.enabled          = false
        singularity.enabled     = false
        podman.enabled          = false
        charliecloud.enabled    = false
        apptainer.enabled       = false
    }
    charliecloud {
        charliecloud.enabled    = true
        conda.enabled           = false
        docker.enabled          = false
        singularity.enabled     = false
        podman.enabled          = false
        shifter.enabled         = false
        apptainer.enabled       = false
    }
    apptainer {
        apptainer.enabled       = true
        apptainer.autoMounts    = true
        conda.enabled           = false
        docker.enabled          = false
        singularity.enabled     = false
        podman.enabled          = false
        shifter.enabled         = false
        charliecloud.enabled    = false
    }
    wave {
        apptainer.ociAutoPull   = true
        singularity.ociAutoPull = true
        wave.enabled            = true
        wave.freeze             = true
        wave.strategy           = 'conda,container'
    }
    gitpod {
        executor.name           = 'local'
        executor.cpus           = 4
        executor.memory         = 8.GB
        process {
            resourceLimits = [
                memory: 8.GB,
                cpus  : 4,
                time  : 1.h
            ]
        }
    }
    test      { includeConfig 'conf/test.config'      }
    test_full { includeConfig 'conf/test_full.config' }

}

// Include default slurm config
includeConfig params.slurm ? "${projectDir}/conf/slurm.config" : "/dev/null"

// Load nf-core custom profiles from different Institutions
includeConfig !System.getenv('NXF_OFFLINE') && params.custom_config_base ? "${params.custom_config_base}/nfcore_custom.config" : "/dev/null"

// Load WrightonLabCSU/dram custom profiles from different institutions.
// TODO nf-core: Optionally, you can add a pipeline-specific nf-core config at https://github.com/nf-core/configs
// includeConfig !System.getenv('NXF_OFFLINE') && params.custom_config_base ? "${params.custom_config_base}/pipeline/dram.config" : "/dev/null"

// Set default registry for Apptainer, Docker, Podman, Charliecloud and Singularity independent of -profile
// Will not be used unless Apptainer / Docker / Podman / Charliecloud / Singularity are enabled
// Set to your registry if you have a mirror of containers
apptainer.registry    = 'quay.io'
docker.registry       = 'quay.io'
podman.registry       = 'quay.io'
singularity.registry  = 'quay.io'
charliecloud.registry = 'quay.io'



// Export these variables to prevent local Python/R libraries from conflicting with those in the container
// The JULIA depot path has been adjusted to a fixed path `/usr/local/share/julia` that needs to be used for packages in the container.
// See https://apeltzer.github.io/post/03-julia-lang-nextflow/ for details on that. Once we have a common agreement on where to keep Julia packages, this is adjustable.

env {
    PYTHONNOUSERSITE = 1
    R_PROFILE_USER   = "/.Rprofile"
    R_ENVIRON_USER   = "/.Renviron"
    JULIA_DEPOT_PATH = "/usr/local/share/julia"
}

// Set bash options
process.shell = """\
bash

set -e # Exit if a tool returns a non-zero status/exit code
set -u # Treat unset variables and parameters as an error
set -o pipefail # Returns the status of the last command to exit with a non-zero status or zero if all successfully execute
set -C # No clobber - prevent output redirection from overwriting files.
"""

// Disable process selector warnings by default. Use debug profile to enable warnings.
nextflow.enable.configProcessNamesValidation = false

timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline_${params.trace_report_suffix}.html"
}
report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report_${params.trace_report_suffix}.html"
}
trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace_${params.trace_report_suffix}.txt"
}
dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/pipeline_dag_${params.trace_report_suffix}.html"
}

manifest {
    name            = 'WrightonLabCSU/dram'
    author          = """Rory M Flynn, Kelly C. Wrighton, Mikayla Borton, Reed Woyda, Madeline Scyphers""" // The author field is deprecated from Nextflow version 24.10.0, use contributors instead
    contributors    = [
        // TODO nf-core: Update the field with the details of the contributors to your pipeline. New with Nextflow version 24.10.0
        [
            name: 'Rory M Flynn',
            affiliation: '',
            email: '',
            github: '',
            contribution: [], // List of contribution types ('author', 'maintainer' or 'contributor')
            orcid: ''
        ],
        [
            name: ' Kelly C. Wrighton',
            affiliation: '',
            email: '',
            github: '',
            contribution: [], // List of contribution types ('author', 'maintainer' or 'contributor')
            orcid: ''
        ],
        [
            name: ' Mikayla Borton',
            affiliation: '',
            email: '',
            github: '',
            contribution: [], // List of contribution types ('author', 'maintainer' or 'contributor')
            orcid: ''
        ],
        [
            name: ' Reed Woyda',
            affiliation: '',
            email: '',
            github: '',
            contribution: [], // List of contribution types ('author', 'maintainer' or 'contributor')
            orcid: ''
        ],
        [
            name: ' Madeline Scyphers',
            affiliation: '',
            email: '',
            github: '',
            contribution: [], // List of contribution types ('author', 'maintainer' or 'contributor')
            orcid: ''
        ],
    ]
    homePage        = 'https://github.com/WrightonLabCSU/dram'
    description     = """DRAM (Distilled and Refined Annotation of Metabolism) is a tool for annotating metagenomic assembled genomes"""
    mainScript      = 'main.nf'
    defaultBranch   = 'master'
    nextflowVersion = '!>=23'
    version         = '2.0.0-beta10'
    doi             = ''
}

// Nextflow plugins
plugins {
    id 'nf-schema@2.0.1' // Validation of pipeline parameters and creation of an input channel from a sample sheet
}

validation {
    defaultIgnoreParams = ["CONSTANTS"]
    monochromeLogs = params.monochrome_logs
    help {
        enabled = true
        command = "nextflow run WrightonLabCSU/dram -profile <docker/singularity/.../institute> --input_fasta path/to/input_fasta <pipeline steps and options, --call, --annotate, etc.> --outdir path/to/outdir"
        fullParameter = "help_full"
        showHiddenParameter = "show_hidden"
    }
}

// Load modules.config for DSL2 module specific options
includeConfig 'conf/modules.config'
